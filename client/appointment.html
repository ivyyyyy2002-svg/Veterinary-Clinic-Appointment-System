<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>appointment</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <!-- Navigation bar -->
    <div class="navbar-dashboard">
        <ul>
            <li><a href="client_dashboard.html">Overview</a></li>
            <li><a href="client_profile.html">Profile</a></li>
            <li><a href="appointment.html">Book Appointments</a></li>
            <li><a href="#" id="logoutBtn">Sign Out</a></li>
        </ul>
    </div>

    <!-- title page -->
    <div class="content">
        <div class="appointment-form" id="appointment_form">
            <h2>Book an Appointment</h2>

            <form id="multiStepForm" novalidate>
            <!-- STEP 1 choose pets and service type -->
            <fieldset id="step1PetService" class="step active" data-step="1">
                <legend>Step 1 — Pet & Service</legend>

                <label for="petSelect">Select your pet</label>
                <select id="petSelect" name="pet" required>
                <option value="">-- Choose a pet --</option>
                <!-- JS will populate pet options here -->
                </select>

                <label for="serviceSelect">Service</label>
                <select id="serviceSelect" name="service" required>
                <option value="">-- Choose a service --</option>
                <!-- JS will populate service options here -->
                </select>

                <div class="step-actions">
                <button type="button" class="btn btn-next">Next</button>
                </div>
                <output id="step1Result"></output>
            </fieldset>

            <!-- STEP 2 choose vet, date, and time -->
            <fieldset class="step" data-step="2">
                <legend>Step 2 — Vet, Date & Time</legend>

                <!-- <label for="vetSelect">Select veterinarian</label>
                <select id="vetSelect" name="vet" required>
                    <option value="">-- Choose a veterinarian --</option>
                    <option value="7">Dr. Ivy Li</option>
                    <option value="8">Dr. Ziqi Liu</option>
                    <option value="9">Dr. Guest</option>

                </select> -->
                <label for="vetSelect">Select veterinarian</label>
                <select id="vetSelect" name="vet" required>
                <option value="">-- Choose a veterinarian --</option>
   
                </select>
                <label for="dateInput">Appointment date</label>
                <input id="dateInput" name="date" type="date" required>

                <label for="timeSelect">Time slot</label>
                <select id="timeSelect" name="time" required>
                <option value="">-- Choose a time --</option>
                
                <option value="09:00">09:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="13:00">01:00 PM</option>
                <option value="14:00">02:00 PM</option>
                <option value="15:00">03:00 PM</option>
                </select>

                <div class="step-actions">
                <button type="button" class="btn btn-prev">Previous</button>
                <button type="button" class="btn btn-next">Next</button>
                </div>
            </fieldset>

            <!-- STEP 3 -->
            <fieldset class="step" data-step="3">
                <legend>Step 3 — Additional notes & Submit</legend>

                <label for="notes">Additional notes (medical history, restrictions, etc.)</label>
                <textarea id="notes" name="notes" rows="5" placeholder="Anything hospital should know..."></textarea>

                <div class="summary" id="appointmentSummary">
                <!-- JS will render a summary here before submit -->
                </div>

                <div class="step-actions">
                <button type="button" class="btn btn-prev">Previous</button>
                <button type="submit" class="btn btn-submit">Submit Appointment</button>
                </div>
            </fieldset>
            </form>
        </div>
    </div>

    <script>
    // login check
    document.addEventListener("DOMContentLoaded", () => {
        const ownerID = localStorage.getItem("ownerID");
        if (!ownerID) {
            alert("Please log in before booking an appointment.");
            localStorage.setItem("postLoginRedirect", "appointment");
            window.location.href = "login.html";
        }
    });

    // Load pets and services
    document.addEventListener("DOMContentLoaded", async () => {
        const ownerID = localStorage.getItem("ownerID");
        if (!ownerID) return;

        const petSelect = document.getElementById("petSelect");
        petSelect.innerHTML = `<option value="">-- Choose a pet --</option>`;

        try {
            const res = await fetch(`http://localhost:5050/api/pets/owner/${ownerID}`);
            const pets = await res.json();

            if (!Array.isArray(pets) || pets.length === 0) {
                petSelect.innerHTML = `<option>No pets found. Register one first.</option>`;
                return;
            }

            pets.forEach(pet => {
                const option = document.createElement("option");
                option.value = pet.petID;
                option.textContent = `${pet.name} (${pet.type})`;
                petSelect.appendChild(option);
            });

        } catch (err) {
            console.error("Failed to load pets:", err);
            petSelect.innerHTML = `<option>Error loading pets</option>`;
        }
    });

    document.addEventListener("DOMContentLoaded", async () => {
        const serviceSelect = document.getElementById("serviceSelect");

        try {
            const res = await fetch("http://localhost:5050/api/diseases");
            const diseases = await res.json();

            diseases.forEach(d => {
                const option = document.createElement("option");
                option.value = d.diseaseID;
                option.textContent = `${d.category} — ${d.diseaseName}`;
                serviceSelect.appendChild(option);
            });

        } catch (err) {
            console.error("Failed to load diseases:", err);
            serviceSelect.innerHTML = `<option>Error loading services</option>`;
        }
    });

    // Multi-step form navigation
    document.addEventListener("DOMContentLoaded", () => {
        const steps = document.querySelectorAll(".step");
        let currentStep = 0;

        function showStep(i) {
            steps.forEach((s, idx) => {
                s.style.display = idx === i ? "block" : "none";
            });
        }

        showStep(currentStep);

        document.querySelectorAll(".btn-next").forEach(btn => {
            btn.addEventListener("click", () => {
                if (currentStep === 0) {
                    if (!document.getElementById("petSelect").value ||
                        !document.getElementById("serviceSelect").value) {
                        alert("Please select a pet and service first.");
                        return;
                    }
                }
                if (currentStep === 1) {
                    if (!document.getElementById("dateInput").value ||
                        !document.getElementById("timeSelect").value) {
                        alert("Please choose date & time.");
                        return;
                    }
                }
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    showStep(currentStep);
                }
            });
        });

        document.querySelectorAll(".btn-prev").forEach(btn => {
            btn.addEventListener("click", () => {
                if (currentStep > 0) {
                    currentStep--;
                    showStep(currentStep);
                }
            });
        });
    });

    // Form submission
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("multiStepForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const ownerID = localStorage.getItem("ownerID");
            const petID = document.getElementById("petSelect").value;
            const diseaseID = document.getElementById("serviceSelect").value;
            const staffID = document.getElementById("vetSelect").value;
            const date = document.getElementById("dateInput").value;
            const time = document.getElementById("timeSelect").value;
            const notes = document.getElementById("notes").value;

            const payload = {
                ownerID,
                petID,
                diseaseID,
                staffID,
                appointmentDate: date,
                appointmentTime: time,
                notes
            };

            try {
                const res = await fetch("http://localhost:5050/api/appointments", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (!res.ok) {
                    alert("Failed to create appointment: " + data.message);
                    return;
                }

                alert("Appointment booked successfully!");
                window.location.href = "client_dashboard.html";

            } catch (err) {
                console.error(err);
                alert("Server error booking appointment");
            }
        });
    });
    // Load staff (veterinarians only)
    document.addEventListener("DOMContentLoaded", async () => {
        const vetSelect = document.getElementById("vetSelect");

        try {
            const res = await fetch("http://localhost:5050/api/staff");
            const staff = await res.json();

            staff.forEach(s => {
                if (s.position && s.position.toLowerCase().includes('veterinarian')) {
                    const option = document.createElement("option");
                    option.value = s.staffID;
                    option.textContent = `${s.name}${s.position ? ' - ' + s.position : ''}${s.specialty ? ' (' + s.specialty + ')' : ''}`;
                    vetSelect.appendChild(option);
                }
            });

        } catch (err) {
            console.error("Failed to load staff:", err);
            vetSelect.innerHTML = `<option>Error loading veterinarians</option>`;
        }
    });
</script>

<script src="JS/signout.js"></script>
</body>
</html>
